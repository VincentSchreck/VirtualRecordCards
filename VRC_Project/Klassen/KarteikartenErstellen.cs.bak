using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using VRC.Model;
using VRC.Handler;

namespace VRC.Klassen
{
    public partial class KarteikartenErstellen : Form
    {
    	        private RecordcardSet ObjRecordcardSet = new RecordcardSet();
        
        private int aktuellerKarteikartenIndex = -1;
        private RecordCardTypeGUI contentGUI;


        public KarteikartenErstellen()
        {
            InitializeComponent();
        }




        private void listBox1_SelectedIndexChanged(object sender, EventArgs e)
        {
            listBxKarteikarten.SelectedIndexChanged -= listBox1_SelectedIndexChanged;
            listBxKarteikarten.BeginUpdate();
            if (listBxKarteikarten.SelectedIndex >= 0)
            {
                if(aktuellerKarteikartenIndex  != -1)
                {
                    Recordcard aktuelleRecordcard = ObjRecordcardSet.RecordcardList[aktuellerKarteikartenIndex];
                    aktuelleRecordcard.Topic = txtBxThema.Text;
                    ObjRecordcardSet.RecordcardList[aktuellerKarteikartenIndex].content = contentGUI.EntnehmeContent();
                    Refresh();
                    listBxKarteikarten.Items[aktuellerKarteikartenIndex] = aktuelleRecordcard.getListboxName();

                }

                Recordcard recordcard = ObjRecordcardSet.RecordcardList[listBxKarteikarten.SelectedIndex];
                txtBxThema.Text = recordcard.Topic;

                tabControl1.Controls.Clear();
                if(recordcard.content.GetType() == typeof(RecordCardTextContent))
                    contentGUI = new RecordcardTextGUI((RecordCardTextContent)recordcard.content);
                else if(recordcard.content.GetType() == typeof(RecordCardAbbildungContent))
                    contentGUI = new RecordcardAbbildungGUI((RecordCardAbbildungContent)recordcard.content);
                else if (recordcard.content.GetType() == typeof(RecordCardAufzaehlungContent))
                    contentGUI = new RecordcardAufzaehlungGUI((RecordCardAufzaehlungContent)recordcard.content);
                else if (recordcard.content.GetType() == typeof(RecordCardMultipleChoiceContent))
                    contentGUI = new RecordcardMultipleChoiceGUI((RecordCardMultipleChoiceContent)recordcard.content);
                this.tabControl1.Controls.Add(contentGUI);
                Refresh();

                aktuellerKarteikartenIndex = listBxKarteikarten.SelectedIndex;
                lblAnzVonKarten.Text = (aktuellerKarteikartenIndex + 1) + "/" + ObjRecordcardSet.RecordcardList.Count();
            }
            listBxKarteikarten.EndUpdate();
            listBxKarteikarten.SelectedIndexChanged += listBox1_SelectedIndexChanged;
        }

        private void btnNeueKarteikarte_Click(object sender, EventArgs e)
        {
            if(comBoxKarteikartentyp.SelectedIndex != -1)
            {

                // Neue Karteikarte erstellen und die, die gerade bearbeitet wird, speichern
                if (aktuellerKarteikartenIndex != -1)
                {
                    ObjRecordcardSet.RecordcardList[aktuellerKarteikartenIndex].content = contentGUI.EntnehmeContent();
                }


                // Art der Karteikarte auslesen und neue Karteikarte erstellen
                tabControl1.Controls.Clear();

                Recordcard recordcard = new Recordcard();
                recordcard.Topic = txtBxThema.Text;

                switch (comBoxKarteikartentyp.SelectedIndex)
                {
                    case 0:
                        contentGUI = new RecordcardTextGUI();
                        break;
                    case 1:
                        contentGUI = new RecordcardAbbildungGUI();
                        break;
                    case 2:
                        contentGUI = new RecordcardAufzaehlungGUI();
                        break;
                    case 3:
                        contentGUI = new RecordcardMultipleChoiceGUI();
                        break;
                        
                }
                this.tabControl1.Controls.Add(contentGUI);
                Refresh();

                ObjRecordcardSet.RecordcardList.Add(recordcard);

                listBxKarteikarten.Items.Clear();
                foreach(Recordcard card in ObjRecordcardSet.RecordcardList) 
                {
                    listBxKarteikarten.Items.Add(card.getListboxName());
                }
                aktuellerKarteikartenIndex = listBxKarteikarten.Items.Count - 1;
                lblAnzVonKarten.Text = (aktuellerKarteikartenIndex + 1) + "/" + ObjRecordcardSet.RecordcardList.Count();
            }
        }

        private void btnKarteikarteLoeschen_Click(object sender, EventArgs e)
        {
            // Aktuelle Karteikarte löschen und die vorherige in der Reihe anzeigen
            if(listBxKarteikarten.SelectedIndex >= 0)
            {
                ObjRecordcardSet.RecordcardList.RemoveAt(listBxKarteikarten.SelectedIndex);
                listBxKarteikarten.Items.RemoveAt(listBxKarteikarten.SelectedIndex);
                //TODO: stimmt noch nicht.
                //aktuellerKarteikartenIndex--;
                txtBxThema.Text = "";
                //listBxKarteikarten.SelectedIndex = -1;
                aktuellerKarteikartenIndex = - 1;
                lblAnzVonKarten.Text = (aktuellerKarteikartenIndex + 1) + "/" + ObjRecordcardSet.RecordcardList.Count();

                tabControl1.Controls.Clear();
            }
        }

        private void btnSpeichern_Click(object sender, EventArgs e)
        {
            var dialogResult = MessageBox.Show("Wollen Sie die aktuelle Sammlung speichern und das Fenster schließen?", "Speichern und schließen?", MessageBoxButtons.YesNo);
            if (dialogResult == DialogResult.Yes)
            {
                if (aktuellerKarteikartenIndex != -1)
                {
                    // Neue Karteikarte erstellen und die, die gerade bearbeitet wird speichern
                    Recordcard aktuelleRecordcard = ObjRecordcardSet.RecordcardList[aktuellerKarteikartenIndex];
                    aktuelleRecordcard.Topic = txtBxThema.Text;
                    listBxKarteikarten.Items[aktuellerKarteikartenIndex] = aktuelleRecordcard.getListboxName();
                    this.ObjRecordcardSet.RecordcardList[aktuellerKarteikartenIndex].content = contentGUI.EntnehmeContent();
                }

                string speicherort = "";
                // Speichern
                SaveFileDialog ofd = new SaveFileDialog();
                ofd.Filter = "xml Dateien (*.xml)|*.xml| Alle Dateien (*.*)|*.*"; ;
                if (ofd.ShowDialog() == DialogResult.OK)
                {
                    speicherort = ofd.FileName; //Dateiname der ausgewählten Datei
                }

                ObjRecordcardSet.Subject = txtBxFach.Text;
                FileHandler.write(XMLHandler.SerializeToXML(ObjRecordcardSet).InnerXml, speicherort);

                // Fenster schließen
                this.Dispose();
            }
            else if (dialogResult == DialogResult.No)
            {
                //TODO: Später bei der Optimierung löschen
            }

        }

        private void btnVerwerfen_Click(object sender, EventArgs e)
        {
            // Abfragefenster Öffnen, ggf löschen und fenster schließen
            DialogResult dialogResult = MessageBox.Show("Wollen Sie die aktuelle Sammlung verwerfen?", "Verwerfen und schließen?", MessageBoxButtons.YesNo);
            if (dialogResult == DialogResult.Yes)
            {
                this.Dispose();
            }
            else if (dialogResult == DialogResult.No)
            {
                //TODO: Später bei der Optimierung löschen
            }
        }

        private void comBoxKarteikartentyp_SelectedIndexChanged(object sender, EventArgs e)
        {
            //tabControl1.Controls.Clear();

            //switch (comBoxKarteikartentyp.SelectedIndex)
            //{
            //    case (int)KarteikartenTyp.Text:
            //        this.tabControl1.Controls.Add(new RecordCardText().GetControls());
            //        break;
            //    case (int)KarteikartenTyp.Abbildung:
            //        this.tabControl1.Controls.Add(new RecordCardAbbildung().GetControls());
            //        break;

            //    case 0:
            //        RecordcardTextGUI recordcardText = new RecordcardTextGUI();
            //        this.tabControl1.Controls.Add(recordcardText);
            //        break;
            //    case 1:
            //        RecordcardAufzaehlungGUI recordcardAufzaehlung = new RecordcardAufzaehlungGUI();
            //        this.tabControl1.Controls.Add(recordcardAufzaehlung);
            //        break;
            //    case 2:
            //        RecordcardMultipleChoiceGUI recordcardMultipleChoice = new RecordcardMultipleChoiceGUI();
            //        this.tabControl1.Controls.Add(recordcardMultipleChoice);
            //        break;
            //    case 3:
            //        RecordcardAbbildungGUI recordcardAbbildung = new RecordcardAbbildungGUI();
            //        this.tabControl1.Controls.Add(recordcardAbbildung);
            //        break;
            //}
            //Refresh();
        }

    }
}
